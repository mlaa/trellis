#!/bin/sh

## Copy restore files from off-site backup. Clone project, install dependencies
## and import restore files.

# Configuration
current_date=`date +%Y%m%d`
project_bin_dir="{{ www_root }}/{{ item.key }}/bin"
project_root_dir="{{ www_root }}/{{ item.key }}/current"
project_env_template="{{ www_root }}/{{ item.key }}/conf/env.template"
nginx_conf_dir="/etc/nginx/sites-available"
restore_dir="/tmp/wordpress-restore"
package_dir="/tmp/wordpress-packages"
production_domain_regex="{{ item.value.env.wp_domain | regex_replace('\\.', '\\\\.') }}"

mysql_s3_restore_file="s3://mla-backup/commons/db/daily/commons-db_$current_date.sql.gz"
wordpress_s3_restore_file="s3://mla-backup/commons/www/daily/commons-www_$current_date.tar.gz"
private_packages_dir="s3://mla-backup/commons/packages"

# Make sure script is not run by root.
if [ "$(id -u)" = "0" ]; then
   echo "Do not run this script as root." 1>&2
   exit 1
fi

# Get FQDN.
fqdn=`hostname -f`

# If no TLD is present, use vagrant.dev.
case "$fqdn" in
  *.*)
    echo "FQDN: $fqdn" ;;
  *)
    fqdn=$fqdn.vagrant.dev
    echo "FQDN: $fqdn" ;;
esac

# Create project directory
mkdir -p $project_root_dir

# Copy restore files.
echo "Downloading restore files...."
mkdir -p $restore_dir
aws s3 cp $wordpress_s3_restore_file $restore_dir/wordpress.backup.tar.gz
aws s3 cp $mysql_s3_restore_file $restore_dir/mysql.backup.sql.gz

# Copy private packages.
echo "Downloading private packages...."
mkdir -p $package_dir
aws s3 sync $private_packages_dir $package_dir

# Clone project and install dependencies.
if [ ! -d "$project_root_dir/.git" ]; then
  cd $project_root_dir
  git init
  git remote add origin {{ item.value.repo }}
  git fetch
  git checkout -t origin/{{ item.value.repo_branch }}
  composer install
fi

# Extract wp-content directory from backup.
echo "Extracting web files...."
tar -C $project_root_dir/web/app/ --strip-components=3 -xvzf $restore_dir/wordpress.backup.tar.gz ./public/wp-content/blogs.dir ./public/wp-content/uploads
{% if web_user != "vagrant" %}
sudo chown -R {{ web_user }}:{{ web_group }} $project_root_dir/web/app/blogs.dir $project_root_dir/web/app/uploads
{% endif %}

# Extract database backup and replace existing database.
echo "Loading database backup...."
gunzip -c $restore_dir/mysql.backup.sql.gz | mysql {{ item.value.env.db_name }}

# Populate .env with development domain.
echo "Updating project environment...."
sed "s/$production_domain_regex/$fqdn/g" $project_env_template > $project_root_dir/.env

# Create wp-cli.local.yml with development domain.
echo "url: http://$fqdn" > $project_root_dir/wp-cli.local.yml

# Generate self-signed certificate.
sudo $project_bin_dir/self-signed-certificate.sh $fqdn

# Update nginx configuration to use development domain.
echo "Updating nginx configuration...."
for file in $nginx_conf_dir/*.conf; do
  sudo sed -i "s/$production_domain_regex/$fqdn/g" $file
done
sudo service nginx restart

# Update database to use development domain.
echo "Updating database...."
wp search-replace \
--skip-columns=guid \
--network \
--url="{{ item.value.env.wp_domain }}" \
--path="$project_root_dir/web/wp" \
"{{ item.value.env.wp_domain }}" "$fqdn"
